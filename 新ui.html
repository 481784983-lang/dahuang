<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">
<style>
    :root {
        /* ---【仙道渺渺·色谱】--- */
        --ink-primary: #2b2b2b;    /* 浓墨 */
        --ink-secondary: #595959;  /* 淡墨 */
        
        /* 核心灵韵 */
        --jade-white: rgba(252, 252, 250, 0.85); /* 羊脂 */
        --gold-leaf: #d4af37;      /* 金箔 */
        --gold-glow: #f9eac4;      /* 金辉 */
        --cinnabar: #c23a3a;       /* 朱砂 */
        --celestial-blue: #5d8aa8; /* 天青 */
        --spirit-cyan: #1abc9c;    /* 灵碧 */
        --mystic-purple: #9b59b6;  /* 紫气 */

        /* 材质变量 */
        --paper-texture: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSI0IiBoZWlnaHQ9IjQiIGZpbGw9IiNmMmYwZTgiIGZpbGwtb3BhY2l0eT0iMC41Ii8+Cjwvc3ZnPg==');
        --shadow-jade: 0 10px 30px -5px rgba(44, 62, 80, 0.15), 0 0 0 1px rgba(255,255,255,0.6) inset;
        --shadow-ink: 0 4px 12px rgba(43, 43, 43, 0.1);
        
        --font-title: 'Ma Shan Zheng', cursive;
        --font-sub: 'ZCOOL XiaoWei', serif;
        --font-body: 'Noto Serif SC', serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
    
    body {
        margin: 0; padding: 0; width: 100%; height: 100vh;
        display: flex; justify-content: center; align-items: center;
        background: #e6e6e6;
        font-family: var(--font-body); color: var(--ink-primary);
        overflow: hidden;
        perspective: 1200px;
    }

    /* === 背景：水墨云烟 === */
    #canvas-bg {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 0; pointer-events: none;
        background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
    }

    /* === 主容器：白玉金书 === */
    .wrapper {
        position: relative; width: 100%; max-width: 480px;
        height: 92vh; min-height: 680px;
        /* 羊脂玉拟态 */
        background: var(--jade-white);
        border-radius: 20px;
        box-shadow: 
            0 20px 50px rgba(0,0,0,0.1),
            0 0 0 1px rgba(255,255,255,0.8) inset, /* 内高光 */
            0 0 40px rgba(212, 175, 55, 0.1);      /* 金色辉光 */
        display: flex; flex-direction: column; overflow: hidden;
        backdrop-filter: blur(20px) saturate(120%);
        z-index: 10;
        transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        transform-style: preserve-3d;
    }
    
    /* 纸张纹理叠加 */
    .wrapper::before {
        content: ''; position: absolute; inset: 0;
        background-image: var(--paper-texture);
        opacity: 0.3; pointer-events: none; z-index: -1;
    }

    /* 战斗状态：血染山河 */
    .wrapper.combat {
        box-shadow: 0 0 60px rgba(194, 58, 58, 0.3);
        animation: combat-pulse 2s infinite ease-in-out;
    }
    .wrapper.combat::after {
        content: ''; position: absolute; inset: 0; border-radius: 20px;
        border: 2px solid rgba(194, 58, 58, 0.2);
        animation: border-flash 1s infinite alternate;
        pointer-events: none;
    }
    @keyframes combat-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.005); } 100% { transform: scale(1); } }

    /* === 顶部：云篆天书 === */
    .header {
        padding: 25px 24px 15px; 
        background: linear-gradient(to bottom, rgba(255,255,255,0.9), rgba(255,255,255,0));
        display: flex; justify-content: space-between; align-items: flex-start;
        flex-shrink: 0; z-index: 20;
    }
    
    /* 地点：金墨大字 */
    #ui-loc {
        font-family: var(--font-title); font-size: 2.4rem;
        color: var(--ink-primary);
        text-shadow: 2px 2px 0px rgba(212, 175, 55, 0.2);
        line-height: 1; margin-bottom: 6px;
        position: relative; display: inline-block;
    }
    /* 装饰印章 */
    #ui-loc::after {
        content: '地界'; font-family: var(--font-sub); font-size: 0.6rem;
        position: absolute; top: -5px; right: -25px;
        border: 1px solid var(--cinnabar); color: var(--cinnabar);
        padding: 1px 3px; border-radius: 4px; transform: rotate(15deg);
    }

    #ui-time {
        font-family: var(--font-sub); font-size: 0.9rem; color: var(--gold-leaf); 
        letter-spacing: 2px; font-weight: bold;
    }
    
    .tag-box { display: flex; gap: 8px; justify-content: flex-end; margin-top: 5px; }
    .tag {
        font-size: 0.7rem; padding: 2px 8px; border-radius: 4px;
        background: rgba(255,255,255,0.6); 
        border: 1px solid rgba(0,0,0,0.05);
        color: var(--ink-secondary); font-family: var(--font-sub);
        display: flex; align-items: center; gap: 4px;
    }

    /* === 内容区 === */
    .content { 
        flex: 1; overflow-y: auto; padding: 10px 20px 20px; 
        scrollbar-width: none;
        /* 顶部和底部淡入淡出遮罩 */
        mask-image: linear-gradient(to bottom, transparent, black 15px, black calc(100% - 15px), transparent);
        -webkit-mask-image: linear-gradient(to bottom, transparent, black 15px, black calc(100% - 15px), transparent);
    }
    .content::-webkit-scrollbar { display: none; }

    /* === 底部：多宝格 === */
    .navbar {
        height: 80px; 
        background: rgba(255,255,255,0.7);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(255,255,255,0.5);
        display: flex; justify-content: space-evenly; align-items: center; 
        padding-bottom: 15px; z-index: 30;
        border-radius: 0 0 20px 20px;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.02);
    }
    .nav-btn {
        display: flex; flex-direction: column; align-items: center; gap: 4px;
        font-size: 0.75rem; color: #a0a0a0; cursor: pointer; 
        width: 60px; height: 60px; justify-content: center;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-family: var(--font-sub);
    }
    .nav-btn i { font-size: 1.3rem; transition: 0.3s; opacity: 0.7; }
    
    .nav-btn.active { color: var(--ink-primary); transform: translateY(-5px); }
    .nav-btn.active i { 
        color: var(--gold-leaf); opacity: 1; transform: scale(1.2);
        filter: drop-shadow(0 0 8px rgba(212,175,55,0.4));
    }
    /* 墨点指示器 */
    .nav-btn.active::after {
        content: ''; width: 4px; height: 4px; background: var(--ink-primary);
        border-radius: 50%; margin-top: 4px;
        box-shadow: 0 0 0 2px rgba(43,43,43,0.1);
    }

    /* === 组件：灵符卡片 === */
    .card { 
        background: rgba(255,255,255,0.5);
        border-radius: 12px; margin-bottom: 16px;
        box-shadow: var(--shadow-jade);
        position: relative; overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid rgba(255,255,255,0.4);
    }
    .card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.8); }
    
    /* 标题栏：洒金纸风格 */
    .card-h { 
        padding: 10px 18px; 
        font-size: 1rem; font-family: var(--font-sub); font-weight: bold; 
        color: var(--ink-primary); 
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 1px solid rgba(0,0,0,0.03);
        background: linear-gradient(90deg, rgba(212,175,55,0.05), transparent);
    }
    .card-h i { margin-right: 6px; color: var(--gold-leaf); }
    .card-b { padding: 15px 18px; font-size: 0.9rem; }

    /* 键值对：玉牌 */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    
    .kv { 
        background: #fff; 
        border: 1px solid rgba(0,0,0,0.02); 
        padding: 8px 4px; border-radius: 8px; 
        text-align: center; display:flex; flex-direction:column; justify-content:center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        transition: all 0.2s;
    }
    .kv:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.05); transform: translateY(-1px); }
    
    .k { font-size: 0.65rem; color: #999; margin-bottom: 3px; font-family: var(--font-sub); letter-spacing: 1px; }
    .v { 
        font-size: 0.9rem; font-weight: bold; color: var(--ink-primary); 
        line-height: 1.1; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    }

    /* 进度条：真气槽 */
    .bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .bar-lbl { width: 32px; text-align: right; font-size: 0.75rem; color: #888; font-family: var(--font-sub); }
    .bar-track { 
        flex: 1; height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden; 
        border: 1px solid rgba(0,0,0,0.02);
    }
    .bar-fill { 
        height: 100%; border-radius: 10px; position: relative;
        transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
    }
    /* 流光 */
    .bar-fill::after {
        content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
        transform: translateX(-100%); animation: qi-flow-bar 2.5s infinite;
    }
    @keyframes qi-flow-bar { 100% { transform: translateX(100%); } }
    .bar-val { width: 35px; text-align: right; font-size: 0.7rem; font-family: monospace; color: #999; }

    /* 列表项：竹简风格 */
    .item { 
        display: flex; gap: 12px; padding: 12px; margin-bottom: 8px;
        background: #fdfdfd; border: 1px solid rgba(0,0,0,0.02); border-radius: 8px;
        align-items: center; transition: all 0.2s; 
    }
    .item:hover { background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.03); transform: translateX(2px); }
    
    .icon { 
        width: 40px; height: 40px; background: #fcfcfc; 
        color: var(--ink-secondary); display: grid; place-items: center; 
        border-radius: 8px; font-size: 1.1rem; flex-shrink: 0; 
        border: 1px solid rgba(0,0,0,0.05);
    }

    /* 模态框：卷轴展开 */
    .modal {
        position: absolute; inset: 0; background: rgba(255, 255, 255, 0.6); z-index: 99;
        display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: 0.4s;
        backdrop-filter: blur(10px);
    }
    .modal.show { opacity: 1; pointer-events: auto; }
    .m-panel {
        width: 100%; height: 85%; background: var(--jade-white);
        border-radius: 24px 24px 0 0; 
        box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
        display: flex; flex-direction: column; 
        transform: translateY(100%); transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        border: 1px solid rgba(255,255,255,0.9);
    }
    .modal.show .m-panel { transform: translateY(0); }
    .m-head { padding: 20px 25px; background: #fff; display: flex; justify-content: space-between; align-items: center; border-radius: 24px 24px 0 0; border-bottom: 1px solid #f2f2f2; }
    .m-body { flex: 1; overflow-y: auto; padding: 25px; }

    /* === 专属修真元素 === */
    
    /* 境界球：内丹 */
    .tier-orb {
        width: 76px; height: 76px; border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #fff, #f0f0f0);
        box-shadow: 
            inset 0 0 10px rgba(255,255,255,1),
            0 0 0 1px rgba(0,0,0,0.05),
            0 8px 20px rgba(212,175,55,0.15); /* 金丹光晕 */
        display: flex; justify-content: center; align-items: center; text-align: center;
        font-family: var(--font-title); font-size: 1.3rem;
        color: var(--ink-primary); padding: 5px;
        position: relative; animation: breathe 4s infinite ease-in-out;
    }
    @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    
    /* 旋转八卦光环 */
    .tier-orb::after {
        content: ''; position: absolute; inset: -6px; border-radius: 50%;
        border: 1px dashed var(--gold-leaf); opacity: 0.4;
        animation: spin-slow 20s linear infinite;
    }
    @keyframes spin-slow { to { transform: rotate(360deg); } }

    /* 标签：符箓 */
    .tag { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; font-family: var(--font-sub); letter-spacing: 0.5px; border: 1px solid transparent; }
    .tag-gold { background: #fff9e6; color: #b8860b; border-color: #ffeeba; }
    .tag-blue { background: #e3f2fd; color: #2980b9; border-color: #bbdefb; }
    .tag-red { background: #fdeaea; color: #c0392b; border-color: #fadbd8; }
    .tag-dark { background: #34495e; color: #fff; border: none; }

    /* 辅助色类 */
    .c-gold { color: var(--gold-leaf); }
    .c-red { color: var(--cinnabar); }
    .c-blue { color: var(--celestial-blue); }
    .c-purple { color: var(--mystic-purple); }
    .c-jade { color: var(--spirit-cyan); }

</style>
</head>
<body>

<canvas id="canvas-bg"></canvas>

<div class="wrapper" id="app">
    <div class="header">
        <div class="h-left">
            <div id="ui-loc">大荒世界</div>
            <div id="ui-time">太古历</div>
        </div>
        <div class="h-right">
            <div id="ui-state" style="font-weight:bold; color:var(--ink-secondary); margin-bottom:6px; font-family:var(--font-title); font-size:1.1rem; text-align:right">世界动态: 平静</div>
            <div class="tag-box">
                <span class="tag" id="ui-qi"><i class="fa-solid fa-wind c-jade"></i> 气: 稀薄</span>
                <span class="tag" id="ui-weather"><i class="fa-solid fa-sun c-gold"></i> 候: 晴</span>
            </div>
            <div style="margin-top:6px; font-size:0.7rem; text-align:right; color:#999; font-family:var(--font-sub)">天道压制: <span id="ui-sup" style="color:var(--cinnabar); font-weight:bold">0%</span></div>
        </div>
    </div>

    <div class="content" id="view"></div>

    <div class="navbar">
        <div class="nav-btn active" onclick="Tab('status')"><i class="fa-solid fa-user-astronaut"></i>道体</div>
        <div class="nav-btn" onclick="Tab('sect')"><i class="fa-solid fa-place-of-worship"></i>宗门</div>
        <div class="nav-btn" onclick="Tab('bag')"><i class="fa-solid fa-sack-dollar"></i>行囊</div>
        <div class="nav-btn" onclick="Tab('social')"><i class="fa-solid fa-fan"></i>寻缘</div>
        <div class="nav-btn" onclick="Tab('news')"><i class="fa-solid fa-scroll"></i>天机</div>
    </div>

    <div class="modal" id="modal">
        <div class="m-panel">
            <div class="m-head">
                <div style="font-weight:bold; font-size:1.6rem; font-family:var(--font-title); color:var(--ink-primary)" id="m-title">详情</div>
                <div onclick="closeModal()" style="font-size:2rem; padding:0 10px; cursor:pointer; color:#ccc; line-height:0.8; transition:color 0.2s">&times;</div>
            </div>
            <div class="m-body" id="m-content"></div>
        </div>
    </div>
</div>

<script>
(function() {

// ===============================================
// 0. 粒子系统 (Spirit Ink System)
// ===============================================
const canvas = document.getElementById('canvas-bg');
const ctx = canvas.getContext('2d');
let particles = [];

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

class InkDrop {
    constructor() {
        this.reset();
    }
    reset() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.size = Math.random() * 2 + 0.5;
        this.speedY = Math.random() * 0.2 + 0.05;
        this.speedX = Math.random() * 0.2 - 0.1;
        this.opacity = Math.random() * 0.3;
        this.color = Math.random() > 0.9 ? '212, 175, 55' : '100, 100, 100'; // 10% Gold, 90% Ink
    }
    update() {
        this.y -= this.speedY; // Float up like spiritual energy
        this.x += this.speedX;
        if (this.y < 0) {
            this.y = canvas.height;
            this.x = Math.random() * canvas.width;
        }
    }
    draw() {
        ctx.fillStyle = `rgba(${this.color}, ${this.opacity})`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
    }
}

function initParticles() { for (let i = 0; i < 60; i++) particles.push(new InkDrop()); }
function animateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < particles.length; i++) {
        particles[i].update();
        particles[i].draw();
    }
    requestAnimationFrame(animateParticles);
}
initParticles();
animateParticles();

// 3D Tilt Interaction
const app = document.getElementById('app');
document.addEventListener('mousemove', (e) => {
    const x = (window.innerWidth / 2 - e.pageX) / 60;
    const y = (window.innerHeight / 2 - e.pageY) / 60;
    app.style.transform = `rotateY(${x}deg) rotateX(${y}deg)`;
});

// ===============================================
// 1. 数据解析 (Robust Parser)
// ===============================================

const get = (root, path) => {
    try {
        if(!root) return undefined;
        return path.split('.').reduce((obj, k) => {
            const m = k.match(/^(.+)\[(\d+)\]$/);
            if(m && obj[m[1]]) return obj[m[1]][parseInt(m[2])];
            return (obj && obj[k] !== undefined) ? obj[k] : undefined;
        }, root);
    } catch(e) { return undefined; }
};

const val = (root, path, def = '无') => {
    const v = get(root, path);
    if(v === undefined || v === null) return def;
    if(Array.isArray(v) && v.length > 0 && typeof v[0] !== 'object') {
        return (v[0] === '' || v[0] === 0) ? (v[0] === 0 ? 0 : def) : v[0];
    }
    if(typeof v === 'object' && !Array.isArray(v)) return def;
    return (v === '' || v === 0) ? (v===0?0:def) : v;
};

const list = (root, path) => {
    const v = get(root, path);
    if(!v) return [];
    if(Array.isArray(v)) {
        return v.filter(i => i && typeof i === 'object' && !i.$meta && (get(i, '名称') || get(i, '姓名')));
    }
    if(typeof v === 'object') {
        return Object.keys(v)
            .filter(k => k !== '$meta')
            .map(k => {
                const item = v[k];
                if(typeof item !== 'object') return null;
                return { ...item, _key: k };
            })
            .filter(i => i !== null && (get(i, '名称') || get(i, '姓名')));
    }
    return [];
};

const bar = (label, cur, max, color) => {
    const c = parseFloat(cur)||0; const m = parseFloat(max)||100;
    const pct = Math.min(100, m>0?(c/m)*100:0);
    return `<div class="bar-row">
        <div class="bar-lbl">${label}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${pct}%; background:${color}; box-shadow: 0 0 10px ${color}66"></div></div>
        <div class="bar-val">${Math.floor(c)}</div>
    </div>`;
};

const kv = (k, v, color='') => `<div class="kv"><div class="k">${k}</div><div class="v" style="color:${color}">${v}</div></div>`;

// ===============================================
// 2. 渲染逻辑 (UI Logic)
// ===============================================
const UI = {
    // 头部
    header: (d) => {
        const w = d['世界']||{};
        const c = d['战斗']||{};
        
        let tStr = val(w,'时间','太古历');
        const rawTime = get(w, '时间');
        if(Array.isArray(rawTime) && rawTime.length > 1 && rawTime[1]) tStr += ` · ${rawTime[1]}`;

        document.getElementById('ui-loc').innerText = val(w,'地点','大荒');
        document.getElementById('ui-time').innerText = tStr;
        document.getElementById('ui-state').innerText = val(w,'世界动态','平静');
        document.getElementById('ui-qi').innerText = '气: ' + val(w,'灵气浓度','稀薄');
        document.getElementById('ui-weather').innerText = '候: ' + val(w,'天气','晴');
        document.getElementById('ui-sup').innerText = val(w,'天道压制', 0) + '%';
        
        const state = val(c,'状态');
        document.getElementById('app').classList.toggle('combat', state !== '空闲' && state !== '无');
    },

    // Tab 1: 道体 (Status)
    status: (d) => {
        const p = d['主角']||{};
        const phy = p['生理']||{};
        const sk = p['技艺']||{};
        
        const kf = list(p,'功法').map(i=>`<span title="${val(i,'描述')}" class="tag tag-gold" style="cursor:help; margin-right:4px; margin-bottom:4px">${val(i,'名称')}</span>`).join('') || '暂无功法';
        const ab = list(p,'神通').map(i=>`<span title="${val(i,'描述')}" class="tag tag-blue" style="cursor:help; margin-right:4px; margin-bottom:4px">${val(i,'名称')}</span>`).join('') || '暂无神通';

        return `
        <div style="display:flex; gap:20px; align-items:center; margin-bottom:25px; padding:0 10px">
            <div class="tier-orb">${val(p,'境界','凡')}</div>
            <div style="flex:1">
                <div style="font-size:2rem; font-weight:bold; color:var(--ink-primary); font-family:var(--font-title); line-height:1; text-shadow:0 1px 0 #fff">${val(p,'姓名','无名氏')}</div>
                <div style="font-size:0.75rem; color:#666; margin-top:8px; display:flex; align-items:center; gap:8px; font-family:var(--font-sub)">
                    <span class="tag tag-dark">${val(p,'种族')}</span>
                    <span style="font-weight:bold">${val(p,'体质')}</span>
                    <span style="color:var(--gold-leaf); font-weight:bold"><i class="fa-solid fa-star"></i> ${val(p,'气运')}</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-h"><span class="c-red"><i class="fa-solid fa-heart-pulse"></i> 根基状态</span></div>
            <div class="card-b">
                ${bar('命', val(p,'当前命'), val(p,'命'), 'linear-gradient(90deg, #c0392b, #e74c3c)')}
                ${bar('灵', val(p,'当前灵'), val(p,'灵'), 'linear-gradient(90deg, #2980b9, #3498db)')}
                ${bar('道心', val(p,'道心'), 100, 'linear-gradient(90deg, #8e44ad, #9b59b6)')}
                ${bar('悟性', val(p,'悟'), 100, 'linear-gradient(90deg, #f39c12, #f1c40f)')}
                ${bar('欲望', val(phy,'欲望槽'), 100, 'linear-gradient(90deg, #d35400, #e67e22)')}
            </div>
        </div>

        <div class="card">
            <div class="card-h"><span class="c-gold"><i class="fa-solid fa-chart-simple"></i> 综合属性</span></div>
            <div class="card-b">
                <div class="grid-4">
                    ${kv('年龄', val(p,'年龄'))}
                    ${kv('战力', val(p,'战力'))}
                    ${kv('神识', val(p,'神识'))}
                    ${kv('魅力', val(p,'魅力'), 'var(--mystic-purple)')}
                </div>
                <div class="grid-3" style="margin-top:10px">
                    ${kv('灵根', val(p,'灵根'))}
                    ${kv('阵营', val(p,'阵营'))}
                    ${kv('名声', val(p,'名声'))}
                    ${kv('体香', val(phy,'体香'), 'var(--mystic-purple)')}
                    ${kv('丹道', val(sk,'炼丹'))}
                    ${kv('器道', val(sk,'炼器'))}
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-h"><span class="c-blue"><i class="fa-solid fa-book-open"></i> 所学</span></div>
            <div class="card-b">
                <div style="margin-bottom:12px">
                    <div style="color:#999;font-size:0.7rem;margin-bottom:6px;font-weight:bold;text-transform:uppercase;letter-spacing:1px">功法</div>
                    <div style="line-height:1.6">${kf}</div>
                </div>
                <div style="border-top:1px dashed rgba(0,0,0,0.05); padding-top:12px">
                    <div style="color:#999;font-size:0.7rem;margin-bottom:6px;font-weight:bold;text-transform:uppercase;letter-spacing:1px">神通</div>
                    <div style="line-height:1.6">${ab}</div>
                </div>
            </div>
        </div>`;
    },

    // Tab 2: 宗门 (Sect)
    sect: (d) => {
        let s = get(d, '宗门.my_sect');
        if (!s || !val(s, '名称') || val(s, '名称') === '无') {
            const rootSect = get(d, '宗门');
            if (rootSect && get(rootSect, '名称')) s = rootSect;
            else if (rootSect) {
                const firstKey = Object.keys(rootSect).find(k => k !== '$meta' && typeof rootSect[k] === 'object' && val(rootSect[k], '名称') !== '无');
                if (firstKey) s = rootSect[firstKey];
            }
        }

        if(!s || !val(s,'名称') || val(s,'名称')==='无' || val(s,'名称')==='未知宗门') 
            return '<div style="text-align:center;padding:100px 20px;color:#999;font-style:italic">暂无宗门归属<br><span style="font-size:0.8rem">请前往大荒寻找机缘</span></div>';
        
        const res = s['资源']||{};
        const blds = s['建筑']||{};
        
        let bHtml = '';
        const bldKeys = Object.keys(blds);
        if (bldKeys.length === 0) bHtml = '<div style="color:#ccc;font-size:0.8rem">暂无建筑</div>';
        else {
            for(let k of bldKeys) {
                if(k==='$meta') continue;
                let raw = blds[k];
                let lv = Array.isArray(raw) ? raw[0] : raw;
                let desc = Array.isArray(raw) && raw[1] ? raw[1] : ''; 
                
                bHtml += `<div class="kv">
                    <div class="k">${k}</div>
                    <div class="v" style="font-size:0.9rem">Lv.${lv}</div>
                    ${desc ? `<div style="font-size:0.6rem;color:#999;margin-top:2px;transform:scale(0.9);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${desc}</div>` : ''}
                </div>`;
            }
        }

        return `
        <div class="card" style="border-top:4px solid var(--gold-leaf); background: linear-gradient(180deg, #fff, #fffcf5);">
            <div class="card-b" style="text-align:center; padding: 30px 10px;">
                <div style="font-family:var(--font-title); font-size:2.2rem; color:var(--ink-primary); margin-bottom:8px; text-shadow: 0 2px 4px rgba(0,0,0,0.05)">${val(s,'名称')}</div>
                <span class="tag tag-gold" style="font-size:0.8rem; box-shadow: 0 4px 10px rgba(212,175,55,0.15)">${val(s,'等级')}品势力</span>
            </div>
            <div class="card-b" style="border-top:1px dashed #eee">
                <div class="grid-3">
                    ${kv('声望', val(s,'声望'))}
                    ${kv('灵脉', val(res,'灵脉'))}
                    ${kv('公款', val(res,'库存灵石'))}
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-h"><span class="c-gold"><i class="fa-solid fa-gopuram"></i> 宗门建筑</span></div>
            <div class="card-b">
                <div class="grid-2">${bHtml}</div>
            </div>
        </div>`;
    },

    // Tab 3: 行囊 (Bag)
    bag: (d) => {
        const a = d['资产']||{};
        const b = list(d, '行囊.背包');

        const currencyList = ['极品灵石','上品灵石','中品灵石','下品灵石','黄金','白银','铜钱'];
        const moneyHtml = currencyList.map(k => {
            const v = val(a, k, 0); 
            let color = '#7f8c8d';
            let icon = '';
            if(k.includes('灵石')) { color = 'var(--celestial-blue)'; icon='<i class="fa-regular fa-gem"></i>'; }
            if(k==='黄金') { color = 'var(--gold-leaf)'; icon='<i class="fa-solid fa-coins"></i>'; }
            return `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #eee; font-size:0.85rem;">
                <span style="color:#999">${icon} ${k}</span> <span style="font-weight:bold; color:${color}; font-family:monospace; font-size:0.95rem">${v}</span>
            </div>`;
        }).join('');

        const itemHtml = b.length ? b.map(i => {
            const q = val(i,'品质','白');
            let qc = '#dfe6e9';
            let tc = '#636e72';
            if(q.includes('金')) { qc = '#ffeaa7'; tc = '#fdcb6e'; }
            else if(q.includes('紫')) { qc = '#dcd6f7'; tc = '#a29bfe'; }
            else if(q.includes('蓝')) { qc = '#dff9fb'; tc = '#74b9ff'; }
            else if(q.includes('绿')) { qc = '#d4edda'; tc = '#55efc4'; }
            return `
            <div class="item">
                <div class="icon" style="color:${tc}; background:${qc}44; border:1px solid ${qc}"><i class="fa-solid fa-box"></i></div>
                <div style="flex:1">
                    <div style="display:flex; justify-content:space-between">
                        <span style="font-weight:bold; color:var(--ink-primary)">${val(i,'名称')}</span>
                        <span style="font-size:0.75rem; color:#999; background:#f5f6fa; padding:2px 8px; border-radius:12px">x${val(i,'数量')}</span>
                    </div>
                    <div style="font-size:0.75rem; color:#999; margin-top:4px; line-height:1.3">${val(i,'描述')}</div>
                </div>
            </div>`;
        }).join('') : '<div style="text-align:center;padding:50px;color:#ccc">纳戒空空如也</div>';

        return `
        <div class="card">
            <div class="card-h"><span class="c-gold"><i class="fa-solid fa-coins"></i> 财帛</span></div>
            <div class="card-b" style="display:grid; grid-template-columns:1fr 1fr; gap:25px">${moneyHtml}</div>
        </div>
        <div class="card">
            <div class="card-h"><span class="c-blue"><i class="fa-solid fa-box-open"></i> 纳戒物品</span></div>
            <div class="card-b">${itemHtml}</div>
        </div>`;
    },

    // Tab 4: 寻缘 (Social)
    social: (d) => {
        const npcs = list(d, '寻缘蝶');
        if(!npcs.length) return '<div style="text-align:center;padding:100px 20px;color:#ccc;font-style:italic">暂无羁绊<br><span style="font-size:0.8rem">红尘炼心，莫问前程</span></div>';
        
        window._npcs = npcs; 

        return npcs.map((n, i) => `
        <div class="card" onclick="openModal(${i})" style="cursor:pointer; transition:transform 0.2s">
            <div class="card-b" style="display:flex; gap:15px; align-items:center">
                <div class="icon" style="width:50px;height:50px;font-size:1.6rem;background:#fff;color:var(--ink-primary);border:1px solid #eee;font-family:var(--font-title)">${val(n,'姓名')[0]}</div>
                <div style="flex:1">
                    <div style="display:flex; justify-content:space-between; margin-bottom:6px">
                        <span style="font-weight:bold; font-size:1.05rem">${val(n,'姓名')} <span style="font-weight:normal;color:#999;font-size:0.75rem; margin-left:5px">${val(n,'道号')||''}</span></span>
                        <span style="color:var(--cinnabar); font-size:0.9rem; font-weight:bold"><i class="fa-solid fa-heart"></i> ${val(n,'好感度')}</span>
                    </div>
                    <div style="display:flex; gap:6px">
                        <span class="tag tag-gold">${val(n,'境界')}</span>
                        <span class="tag tag-blue">${val(n,'关系')}</span>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right" style="color:#ddd"></i>
            </div>
        </div>`).join('');
    },

    // Tab 5: 天机 (News)
    news: (d) => {
        const n = d['宅仙报']||{};
        const logs = val(d,'战斗.战斗日志')||[];
        const logArr = Array.isArray(logs)?logs:[logs];
        const pets = list(d, '灵兽栏'); 

        const petHtml = pets.length ? pets.map(p => `
        <div class="item">
            <div class="icon" style="background:#e3f2fd; color:#0984e3; border:none"><i class="fa-solid fa-paw"></i></div>
            <div style="flex:1">
                <div style="display:flex; justify-content:space-between">
                    <span style="font-weight:bold">${val(p,'名称')} <span style="font-size:0.7rem;color:#999;font-weight:normal">(${val(p,'种族')})</span></span>
                    <span class="tag tag-gold">${val(p,'境界')}</span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:6px">
                    <span class="tag" style="background:#f5f6fa;border:none;color:#999">${val(p,'化形状态')}</span>
                    <div style="flex:1; margin-left:15px">${bar('忠诚', val(p,'忠诚度'), 100, '#00b894').replace('margin-bottom: 12px', 'margin-bottom: 0')}</div>
                </div>
            </div>
        </div>`).join('') : '<div style="text-align:center;color:#ccc">无灵兽</div>';

        return `
        ${logArr[0] !== '暂无战斗记录' ? `<div class="card" style="border-left:4px solid var(--cinnabar); background:#fff5f5"><div class="card-h" style="background:transparent; color:var(--cinnabar); border:none"><span style="font-weight:bold"><i class="fa-solid fa-bolt"></i> 战斗速报</span></div><div class="card-b" style="line-height:1.6; color:#2d3436">${logArr.join('<br>')}</div></div>` : ''}

        <div class="card">
            <div class="card-h"><span class="c-jade"><i class="fa-solid fa-dragon"></i> 灵兽栏</span></div>
            <div class="card-b">${petHtml}</div>
        </div>

        <div class="card">
            <div class="card-h"><span class="c-purple"><i class="fa-solid fa-scroll"></i> 宅仙报</span></div>
            <div class="card-b">
                <div style="margin-bottom:15px; padding-bottom:12px; border-bottom:1px dashed #eee">
                    <div style="font-weight:bold; color:var(--celestial-blue); font-size:0.9rem; margin-bottom:6px">天机阁榜单</div>
                    <div style="color:var(--ink-secondary); line-height:1.5">${val(n,'天机阁')}</div>
                </div>
                <div style="margin-bottom:15px; padding-bottom:12px; border-bottom:1px dashed #eee">
                    <div style="font-weight:bold; color:var(--gold-leaf); font-size:0.9rem; margin-bottom:6px">散仙小道</div>
                    <div style="color:var(--ink-secondary); line-height:1.5">${val(n,'散仙小道')}</div>
                </div>
                <div>
                    <div style="font-weight:bold; color:var(--cinnabar); font-size:0.9rem; margin-bottom:6px">宅仙有话说</div>
                    <div style="color:#636e72; font-style:italic; line-height:1.5; background:#f9f9f9; padding:10px; border-radius:8px">"${val(n,'宅仙有话说')}"</div>
                </div>
            </div>
        </div>`;
    }
};

// ===============================================
// 3. 交互逻辑 (Interaction)
// ===============================================
let lastData = {};

window.Tab = (key) => {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const idx = ['status','sect','bag','social','news'].indexOf(key);
    if(idx >= 0) document.querySelectorAll('.nav-btn')[idx].classList.add('active');
    
    const view = document.getElementById('view');
    view.scrollTop = 0;
    view.innerHTML = UI[key] ? UI[key](lastData) : '<div style="padding:50px;text-align:center;color:#bdc3c7"><i class="fa-solid fa-circle-notch fa-spin"></i> 天道演算中...</div>';
};

window.openModal = (idx) => {
    const n = window._npcs[idx];
    if(!n) return;
    
    const sens = n['敏感度'] || (n['生理'] ? n['生理']['敏感度'] : {}) || {};
    const preg = n['孕育'] || (n['生理'] ? n['生理']['孕育'] : {}) || {};
    
    const npcSkill = list(n, '功法').map(i => `<span class="tag tag-gold">${val(i,'名称')}</span>`).join('') || '<span style="color:#ccc;font-size:0.7rem">无</span>';
    const npcAbility = list(n, '神通').map(i => `<span class="tag tag-blue">${val(i,'名称')}</span>`).join('') || '<span style="color:#ccc;font-size:0.7rem">无</span>';

    let sensHtml = '';
    for(let k in sens) {
        if(k==='$meta') continue;
        let v = Array.isArray(sens[k])?sens[k][0]:sens[k];
        sensHtml += bar(k, v, 100, '#9b59b6');
    }

    const html = `
    <div style="display:flex; gap:20px; margin-bottom:25px; align-items:center;">
        <div class="tier-orb" style="width:80px;height:80px;font-size:2rem;background:#fff;color:var(--gold-leaf);">${val(n,'姓名')[0]}</div>
        <div style="flex:1">
            <div style="font-size:1.8rem; font-weight:bold; color:var(--ink-primary); font-family:var(--font-title); line-height:1.1">${val(n,'姓名')} <span style="font-size:0.8rem; color:#999; font-weight:normal; font-family:var(--font-body)">${val(n,'道号')||''}</span></div>
            <div style="display:flex; gap:8px; margin-top:8px">
                <span class="tag tag-gold">${val(n,'境界')}</span>
                <span class="tag" style="background:#f5f6fa; border:1px solid #eee; color:#636e72">${val(n,'当前状态','正常')}</span>
            </div>
            <div style="font-size:0.85rem; color:#636e72; margin-top:10px; font-style:italic; border-left:3px solid var(--gold-leaf); padding-left:10px">"${val(n,'心理活动','...')}"</div>
        </div>
    </div>

    <div class="card">
        <div class="card-h"><span>状态与道法</span></div>
        <div class="card-b">
            ${bar('命', val(n,'当前命'), val(n,'命'), '#c0392b')}
            ${bar('灵', val(n,'当前灵'), val(n,'灵'), '#2980b9')}
            ${bar('道心', val(n,'道心'), 100, '#8e44ad')}
            <div style="margin-top:15px; border-top:1px dashed #eee; padding-top:12px">
                <div class="grid-2">
                    <div>
                        <div style="font-size:0.75rem; color:#999; margin-bottom:6px">所修功法</div>
                        <div style="line-height:1.6">${npcSkill}</div>
                    </div>
                    <div>
                        <div style="font-size:0.75rem; color:#999; margin-bottom:6px">掌握神通</div>
                        <div style="line-height:1.6">${npcAbility}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-h">基础档案</div>
        <div class="card-b">
            <div class="grid-4">
                ${kv('种族', val(n,'种族'))}
                ${kv('年龄', val(n,'年龄'))}
                ${kv('气运', val(n,'气运'), 'var(--gold-leaf)')}
                ${kv('势力', val(n,'势力'))}
            </div>
            <div class="grid-3" style="margin-top:10px">
                ${kv('灵根', val(n,'灵根'))}
                ${kv('体质', val(n,'体质'))}
                ${kv('灵器', val(n,'灵器'))}
                ${kv('所在地', val(n,'所在地'))}
                ${kv('三围', val(n,'三围'))}
                ${kv('标记', val(n,'标记'))}
            </div>
            <div class="grid-3" style="margin-top:10px; border-top:1px dashed #eee; padding-top:10px">
                ${kv('性格', val(n,'性格'))}
                ${val(n,'性格2') && val(n,'性格2')!=='未知' ? kv('隐性', val(n,'性格2')) : ''}
                ${kv('弱点', val(n,'弱点'))}
                ${kv('喜好', val(n,'喜好'))}
                ${kv('嫉妒心', val(n,'嫉妒心'), 'var(--cinnabar)')}
            </div>
        </div>
    </div>

    <div class="card" style="border:1px solid #f3e5f5; box-shadow:0 8px 20px rgba(162, 155, 254, 0.2)">
        <div class="card-h" style="background:linear-gradient(to right, #f3e5f5, #fff); color:#8e44ad">极乐档案</div>
        <div class="card-b">
            ${bar('好感', val(n,'好感度'), 100, '#c0392b')}
            ${bar('顺从', val(n,'顺从度'), 100, '#2980b9')}
            ${bar('堕落', val(n,'堕落值'), 100, '#34495e')}

            <div class="grid-2" style="margin-top:15px; margin-bottom:15px">
                ${kv('元阴', val(n,'元阴'), String(val(n,'元阴')).includes('锁')?'var(--gold-leaf)':'var(--cinnabar)')}
                ${kv('合欢次数', val(n,'合欢数'))}
            </div>
            
            <div style="background:#fdf2f7; padding:10px; border-radius:8px; text-align:center; border:1px solid #f8bbd0; margin-bottom:15px">
                <span style="font-size:0.75rem; color:#888">孕育状态: </span>
                <span style="font-weight:bold; color:var(--cinnabar); font-size:0.95rem">${val(preg,'状态')} <span style="font-size:0.75rem">(${val(preg,'进度')}%)</span></span>
            </div>

            <div style="border-top:1px dashed #f0d0e0; padding-top:12px">
                <div style="font-size:0.75rem; color:#9b59b6; margin-bottom:8px; font-weight:bold">敏感度开发</div>
                ${sensHtml || '<div style="color:#ccc; font-size:0.7rem">未知</div>'}
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-b" style="line-height:1.6">
            <div style="margin-bottom:8px"><strong style="color:var(--gold-leaf)">外貌：</strong> <span style="color:var(--ink-secondary)">${val(n,'外貌')}</span></div>
            <div><strong style="color:var(--gold-leaf)">衣着：</strong> <span style="color:var(--ink-secondary)">${val(n,'衣着')}</span></div>
        </div>
    </div>
    `;
    
    document.getElementById('m-title').innerText = val(n,'姓名');
    document.getElementById('m-content').innerHTML = html;
    document.getElementById('modal').classList.add('show');
};

window.closeModal = () => document.getElementById('modal').classList.remove('show');

// ===============================================
// 4. 初始化
// ===============================================
const init = async () => {
    try {
        let d = {};
        if (typeof getChatMessages === 'function') {
            const msgs = await getChatMessages(getCurrentMessageId());
            d = msgs?.[0]?.data?.stat_data || {};
        } else if (window.lastData) {
            d = window.lastData;
        }
        lastData = d;
        UI.header(d);
        Tab('status'); 
        
        if (typeof waitGlobalInitialized === 'function') {
            waitGlobalInitialized('Mvu').then(() => {
                if (typeof Mvu !== 'undefined') {
                    eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, m => {
                        if (m?.stat_data) {
                            lastData = m.stat_data;
                            UI.header(lastData);
                            const active = document.querySelector('.nav-btn.active');
                            const key = active ? active.getAttribute('onclick').match(/'(.*)'/)[1] : 'status';
                            Tab(key);
                        }
                    });
                }
            });
        }
    } catch (e) { console.error(e); }
};

if (typeof waitGlobalInitialized === 'function') waitGlobalInitialized('Mvu').then(init);
else setTimeout(init, 100);

})();
</script>
</body>
</html>