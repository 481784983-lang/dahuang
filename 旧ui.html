<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&family=Ma+Shan+Zheng&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
<style>
    :root {
        /* ---【太玄真本·色板】--- */
        --bg-paper: #f7f5f0;
        --bg-card: #ffffff;
        
        --text-main: #2b2b2b;
        --text-sub: #666666;
        --text-mute: #999999;

        /* 雅致五色 */
        --ink: #2c3e50;         /* 墨 */
        --gold: #b89357;        /* 鎏金 */
        --vermilion: #c0392b;   /* 朱砂 */
        --cyan: #548c8d;        /* 黛青 */
        --purple: #8e73ad;      /* 紫檀 */

        /* 间距与圆角 */
        --radius: 12px;
        --gap: 16px;
        
        /* 阴影：纸张层叠感 */
        --shadow-sm: 0 2px 8px rgba(44, 62, 80, 0.04);
        --shadow-md: 0 8px 24px rgba(44, 62, 80, 0.06);
        --shadow-float: 0 15px 40px rgba(184, 147, 87, 0.15);

        --font-title: 'Ma Shan Zheng', cursive;
        --font-body: 'Noto Serif SC', serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
    
    body {
        margin: 0; padding: 0; width: 100%; height: 100vh;
        display: flex; justify-content: center; align-items: center;
        background-color: #e8e6e1;
        /* 宣纸纹理 */
        background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        font-family: var(--font-body); color: var(--text-main);
    }

    /* === 主容器 === */
    .wrapper {
        position: relative; width: 100%; max-width: 460px; height: 92vh; min-height: 600px;
        background: var(--bg-paper);
        border-radius: 20px;
        box-shadow: var(--shadow-float), 0 0 0 1px rgba(0,0,0,0.02);
        display: flex; flex-direction: column; overflow: hidden;
        border: 4px solid #fff; /* 白框装裱 */
    }
    
    /* 装饰：内边框线 */
    .wrapper::after {
        content: ''; position: absolute; inset: 12px; 
        border: 1px solid rgba(184, 147, 87, 0.2); border-radius: 12px;
        pointer-events: none; z-index: 99;
    }

    /* 战斗红光 */
    .wrapper.combat { border-color: #fadbd8; box-shadow: 0 0 40px rgba(192, 57, 43, 0.2); }

    /* === 顶部：雅致抬头 === */
    .header {
        padding: 24px 28px 16px; background: transparent;
        display: flex; justify-content: space-between; align-items: flex-end;
        border-bottom: 1px solid rgba(0,0,0,0.03); z-index: 2;
    }
    
    #ui-loc {
        font-family: var(--font-title); font-size: 2.2rem; color: var(--ink);
        line-height: 1; letter-spacing: 2px;
        text-shadow: 2px 2px 0 rgba(0,0,0,0.05);
    }
    
    .status-group { text-align: right; }
    #ui-time { font-size: 0.75rem; color: var(--gold); letter-spacing: 1px; font-weight: 700; margin-bottom: 4px; text-transform: uppercase; }
    
    .pill-box { display: flex; gap: 6px; justify-content: flex-end; }
    .pill {
        font-size: 0.6rem; padding: 2px 8px; border-radius: 4px;
        background: #fff; border: 1px solid rgba(0,0,0,0.05);
        color: var(--text-sub);
    }

    /* === 内容区 === */
    .content { 
        flex: 1; overflow-y: auto; padding: 20px 24px; 
        scrollbar-width: none;
    }
    .content::-webkit-scrollbar { display: none; }

    /* === 底部：悬浮导航 === */
    .navbar {
        height: 72px; background: #fff;
        display: flex; justify-content: space-between; align-items: center; 
        padding: 0 20px; border-top: 1px solid rgba(0,0,0,0.03);
        box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
    }
    .nav-btn {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        gap: 4px; height: 100%; flex: 1;
        font-size: 0.7rem; color: #ccc; cursor: pointer;
        transition: all 0.3s ease; position: relative;
    }
    .nav-btn i { font-size: 1.2rem; transition: transform 0.3s; }
    
    .nav-btn.active { color: var(--ink); }
    .nav-btn.active i { transform: translateY(-2px) scale(1.1); color: var(--gold); }
    /* 墨点指示器 */
    .nav-btn.active::after {
        content: ''; position: absolute; bottom: 12px; width: 4px; height: 4px; 
        background: var(--ink); border-radius: 50%;
    }

    /* === 组件系统 === */

    /* 1. 标题栏 */
    .sec-title {
        display: flex; align-items: center; gap: 8px;
        font-size: 0.85rem; font-weight: 700; color: var(--ink);
        margin: 24px 0 12px; padding-left: 4px;
        border-left: 3px solid var(--gold); line-height: 1;
    }
    .sec-title i { color: var(--text-mute); font-size: 0.8rem; }
    
    /* 2. 纯净卡片 */
    .card {
        background: var(--bg-card); border-radius: var(--radius);
        padding: 16px; margin-bottom: 12px;
        box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.02);
        position: relative; transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:active { transform: scale(0.99); }

    /* 3. 数据网格 (Key-Value Grid) - 极简主义 */
    .data-grid { display: grid; gap: 12px; }
    .g-2 { grid-template-columns: 1fr 1fr; }
    .g-3 { grid-template-columns: repeat(3, 1fr); }
    .g-4 { grid-template-columns: repeat(4, 1fr); }

    .kv-box { text-align: center; }
    .kv-k { font-size: 0.6rem; color: var(--text-mute); margin-bottom: 4px; letter-spacing: 0.5px; }
    .kv-v { 
        font-size: 0.9rem; font-weight: 700; color: var(--ink); 
        line-height: 1.2; font-family: var(--font-body);
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* 4. 进度条 (极细雅致版) */
    .prog-wrap { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .prog-lbl { width: 30px; font-size: 0.7rem; color: var(--text-sub); text-align: right; font-weight: bold; }
    .prog-track { flex: 1; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; }
    .prog-bar { height: 100%; border-radius: 3px; }
    .prog-val { width: 32px; font-size: 0.65rem; color: var(--text-mute); text-align: right; font-family: monospace; }

    /* 5. 列表项 (Clean List) */
    .list-item { 
        display: flex; align-items: center; gap: 12px; 
        padding: 12px 0; border-bottom: 1px dashed #eee;
    }
    .list-item:last-child { border-bottom: none; padding-bottom: 0; }
    .item-icon {
        width: 36px; height: 36px; border-radius: 8px;
        background: #fcfcfc; border: 1px solid #eee; color: var(--text-sub);
        display: grid; place-items: center; font-size: 1rem; flex-shrink: 0;
    }
    .item-main { flex: 1; overflow: hidden; }
    .item-title { font-size: 0.9rem; font-weight: 700; color: var(--ink); display: flex; justify-content: space-between; }
    .item-sub { font-size: 0.7rem; color: var(--text-mute); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* === 特殊修真组件 === */

    /* 境界印章 */
    .seal {
        width: 64px; height: 64px; border: 2px solid var(--gold); border-radius: 12px;
        display: grid; place-items: center; 
        font-family: var(--font-title); font-size: 1.1rem; color: var(--ink);
        background: #fff; box-shadow: 4px 4px 0 rgba(184, 147, 87, 0.1);
        transform: rotate(-3deg);
    }

    /* 标签 Tag */
    .tag { 
        display: inline-block; padding: 2px 6px; border-radius: 4px; 
        font-size: 0.65rem; border: 1px solid transparent; 
        vertical-align: middle;
    }
    .t-gold { background: #fffbf0; color: var(--gold); border-color: rgba(184,147,87,0.2); }
    .t-cyan { background: #f0f8ff; color: var(--cyan); border-color: rgba(84,140,141,0.2); }
    .t-red { background: #fdf2f0; color: var(--vermilion); border-color: rgba(192,57,43,0.2); }
    .t-outline { border: 1px solid #eee; color: var(--text-sub); }

    /* === 模态框 (Modal) === */
    .modal {
        position: absolute; inset: 0; background: rgba(255,255,255,0.8); z-index: 100;
        display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: 0.3s;
        backdrop-filter: blur(5px);
    }
    .modal.show { opacity: 1; pointer-events: auto; }
    
    .m-card {
        width: 100%; height: 90%; background: #fff;
        border-radius: 24px 24px 0 0;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
        display: flex; flex-direction: column;
        transform: translateY(100%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        border: 1px solid rgba(0,0,0,0.05);
    }
    .modal.show .m-card { transform: translateY(0); }
    
    .m-head { padding: 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f5f5f5; }
    .m-body { flex: 1; overflow-y: auto; padding: 24px; background: #fafafa; }

    /* 颜色辅助类 */
    .c-gold { color: var(--gold); }
    .c-red { color: var(--vermilion); }
    .c-cyan { color: var(--cyan); }
    .c-purple { color: var(--purple); }

</style>
</head>
<body>

<div class="wrapper" id="app">
    <div class="header">
        <div class="h-left">
            <div id="ui-loc">大荒</div>
        </div>
        <div class="status-group">
            <div id="ui-time">太古历</div>
            <div class="pill-box">
                <span class="pill" id="ui-qi">气: 稀薄</span>
                <span class="pill" id="ui-weather">候: 晴</span>
                <span class="pill" id="ui-state" style="color:var(--text-main); font-weight:bold">平静</span>
            </div>
            <div style="font-size:0.6rem; color:#ccc; margin-top:2px; text-align:right">压制: <span id="ui-sup" style="color:var(--vermilion)">0%</span></div>
        </div>
    </div>

    <div class="content" id="view"></div>

    <div class="navbar">
        <div class="nav-btn active" onclick="Tab('status')"><i class="fa-solid fa-user-astronaut"></i>道体</div>
        <div class="nav-btn" onclick="Tab('sect')"><i class="fa-solid fa-place-of-worship"></i>宗门</div>
        <div class="nav-btn" onclick="Tab('bag')"><i class="fa-solid fa-sack-dollar"></i>行囊</div>
        <div class="nav-btn" onclick="Tab('social')"><i class="fa-solid fa-fan"></i>寻缘</div>
        <div class="nav-btn" onclick="Tab('news')"><i class="fa-solid fa-scroll"></i>天机</div>
    </div>

    <div class="modal" id="modal">
        <div class="m-card">
            <div class="m-head">
                <div style="font-size:1.4rem; font-family:var(--font-title); color:var(--ink)" id="m-title">详情</div>
                <div onclick="closeModal()" style="font-size:1.5rem; color:#ccc; cursor:pointer"><i class="fa-solid fa-xmark"></i></div>
            </div>
            <div class="m-body" id="m-content"></div>
        </div>
    </div>
</div>

<script>
(function() {

// ===============================================
// 1. 数据解析 (Logic Core - 保持不变)
// ===============================================

const get = (root, path) => {
    try {
        if(!root) return undefined;
        return path.split('.').reduce((obj, k) => {
            const m = k.match(/^(.+)\[(\d+)\]$/);
            if(m && obj[m[1]]) return obj[m[1]][parseInt(m[2])];
            return (obj && obj[k] !== undefined) ? obj[k] : undefined;
        }, root);
    } catch(e) { return undefined; }
};

const val = (root, path, def = '无') => {
    const v = get(root, path);
    if(v === undefined || v === null) return def;
    if(Array.isArray(v) && v.length > 0 && typeof v[0] !== 'object') {
        return (v[0] === '' || v[0] === 0) ? (v[0] === 0 ? 0 : def) : v[0];
    }
    if(typeof v === 'object' && !Array.isArray(v)) return def;
    return (v === '' || v === 0) ? (v===0?0:def) : v;
};

const list = (root, path) => {
    const v = get(root, path);
    if(!v) return [];
    if(Array.isArray(v)) {
        return v.filter(i => i && typeof i === 'object' && !i.$meta && (get(i, '名称') || get(i, '姓名')));
    }
    if(typeof v === 'object') {
        return Object.keys(v)
            .filter(k => k !== '$meta')
            .map(k => {
                const item = v[k];
                if(typeof item !== 'object') return null;
                return { ...item, _key: k };
            })
            .filter(i => i !== null && (get(i, '名称') || get(i, '姓名')));
    }
    return [];
};

// UI组件：进度条 (New Style)
const bar = (label, cur, max, color) => {
    const c = parseFloat(cur)||0; const m = parseFloat(max)||100;
    const pct = Math.min(100, m>0?(c/m)*100:0);
    return `<div class="prog-wrap">
        <div class="prog-lbl">${label}</div>
        <div class="prog-track"><div class="prog-bar" style="width:${pct}%; background:${color}"></div></div>
        <div class="prog-val">${Math.floor(c)}</div>
    </div>`;
};

// UI组件：KV块
const kv = (k, v, color='') => `<div class="kv-box"><div class="kv-k">${k}</div><div class="kv-v" style="color:${color}">${v}</div></div>`;

// ===============================================
// 2. 渲染逻辑 (UI Render)
// ===============================================
const UI = {
    // 头部
    header: (d) => {
        const w = d['世界']||{};
        const c = d['战斗']||{};
        
        let tStr = val(w,'时间','太古历');
        const rawTime = get(w, '时间');
        if(Array.isArray(rawTime) && rawTime.length > 1 && rawTime[1]) tStr += ` · ${rawTime[1]}`;

        document.getElementById('ui-loc').innerText = val(w,'地点','大荒');
        document.getElementById('ui-time').innerText = tStr;
        document.getElementById('ui-state').innerText = val(w,'世界动态','平静');
        document.getElementById('ui-qi').innerText = '气: ' + val(w,'灵气浓度','稀薄');
        document.getElementById('ui-weather').innerText = '候: ' + val(w,'天气','晴');
        document.getElementById('ui-sup').innerText = val(w,'天道压制', 0) + '%';
        
        const state = val(c,'状态');
        document.getElementById('app').classList.toggle('combat', state !== '空闲' && state !== '无');
    },

    // Tab 1: 道体 (Status)
    status: (d) => {
        const p = d['主角']||{};
        const phy = p['生理']||{};
        const sk = p['技艺']||{};
        
        const kf = list(p,'功法').map(i=>`<span title="${val(i,'描述')}" class="tag t-gold" style="cursor:help; margin-right:4px; margin-bottom:4px">${val(i,'名称')}</span>`).join('') || '<span class="tag t-outline">暂无功法</span>';
        const ab = list(p,'神通').map(i=>`<span title="${val(i,'描述')}" class="tag t-cyan" style="cursor:help; margin-right:4px; margin-bottom:4px">${val(i,'名称')}</span>`).join('') || '<span class="tag t-outline">暂无神通</span>';

        return `
        <div style="display:flex; gap:20px; align-items:center; margin-bottom:20px;">
            <div class="seal">${val(p,'境界','凡')}</div>
            <div style="flex:1">
                <div style="font-size:1.6rem; font-weight:bold; color:var(--ink); font-family:var(--font-title)">${val(p,'姓名','无名氏')}</div>
                <div style="font-size:0.75rem; color:var(--text-sub); margin-top:6px;">
                    <span class="tag t-outline">${val(p,'种族')}</span>
                    <span style="margin:0 6px">${val(p,'体质')}</span>
                    <span class="c-gold"><i class="fa-solid fa-star"></i> ${val(p,'气运')}</span>
                </div>
            </div>
        </div>

        <div class="sec-title"><i class="fa-solid fa-heart-pulse"></i> 根基状态</div>
        <div class="card">
            ${bar('命', val(p,'当前命'), val(p,'命'), '#c0392b')}
            ${bar('灵', val(p,'当前灵'), val(p,'灵'), '#2980b9')}
            ${bar('道心', val(p,'道心'), 100, '#8e44ad')}
            ${bar('悟性', val(p,'悟'), 100, '#d4af37')}
            ${bar('欲望', val(phy,'欲望槽'), 100, '#ff7675')}
        </div>

        <div class="sec-title"><i class="fa-solid fa-chart-simple"></i> 综合属性</div>
        <div class="card">
            <div class="data-grid g-4" style="margin-bottom:12px; border-bottom:1px dashed #eee; padding-bottom:12px">
                ${kv('年龄', val(p,'年龄'))}
                ${kv('战力', val(p,'战力'))}
                ${kv('神识', val(p,'神识'))}
                ${kv('魅力', val(p,'魅力'), 'var(--purple)')}
            </div>
            <div class="data-grid g-3">
                ${kv('灵根', val(p,'灵根'))}
                ${kv('阵营', val(p,'阵营'))}
                ${kv('名声', val(p,'名声'))}
                ${kv('体香', val(phy,'体香'), 'var(--purple)')}
                ${kv('丹道', val(sk,'炼丹'))}
                ${kv('器道', val(sk,'炼器'))}
            </div>
        </div>

        <div class="sec-title"><i class="fa-solid fa-book-open"></i> 所学</div>
        <div class="card">
            <div style="margin-bottom:10px">
                <div style="font-size:0.65rem; color:#aaa; margin-bottom:6px">功法</div>
                <div style="line-height:1.6">${kf}</div>
            </div>
            <div style="border-top:1px dashed #eee; padding-top:10px">
                <div style="font-size:0.65rem; color:#aaa; margin-bottom:6px">神通</div>
                <div style="line-height:1.6">${ab}</div>
            </div>
        </div>`;
    },

    // Tab 2: 宗门 (Sect)
    sect: (d) => {
        let s = get(d, '宗门.my_sect');
        if (!s || !val(s, '名称') || val(s, '名称') === '无') {
            const rootSect = get(d, '宗门');
            if (rootSect && get(rootSect, '名称')) s = rootSect;
            else if (rootSect) {
                const firstKey = Object.keys(rootSect).find(k => k !== '$meta' && typeof rootSect[k] === 'object' && val(rootSect[k], '名称') !== '无');
                if (firstKey) s = rootSect[firstKey];
            }
        }

        if(!s || !val(s,'名称') || val(s,'名称')==='无' || val(s,'名称')==='未知宗门') 
            return '<div style="text-align:center;padding:100px 20px;color:#ccc;">暂无宗门归属<br><span style="font-size:0.75rem">请前往大荒寻找机缘</span></div>';
        
        const res = s['资源']||{};
        const blds = s['建筑']||{};
        
        let bHtml = '';
        const bldKeys = Object.keys(blds);
        if (bldKeys.length === 0) bHtml = '<div style="color:#ccc;font-size:0.8rem">暂无建筑</div>';
        else {
            for(let k of bldKeys) {
                if(k==='$meta') continue;
                let raw = blds[k];
                let lv = Array.isArray(raw) ? raw[0] : raw;
                let desc = Array.isArray(raw) && raw[1] ? raw[1] : ''; 
                
                bHtml += `<div class="kv-box" style="padding:10px; background:#f9f9f9; border-radius:8px">
                    <div class="kv-k">${k}</div>
                    <div class="kv-v" style="font-size:0.9rem">Lv.${lv}</div>
                    ${desc ? `<div style="font-size:0.6rem;color:#999;margin-top:2px;transform:scale(0.9);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${desc}</div>` : ''}
                </div>`;
            }
        }

        return `
        <div class="card" style="text-align:center; padding: 25px 10px;">
            <div style="font-family:var(--font-title); font-size:2rem; color:var(--ink); margin-bottom:8px">${val(s,'名称')}</div>
            <span class="tag t-gold">${val(s,'等级')}品势力</span>
            
            <div class="data-grid g-3" style="margin-top:20px; border-top:1px dashed #eee; padding-top:15px">
                ${kv('声望', val(s,'声望'))}
                ${kv('灵脉', val(res,'灵脉'))}
                ${kv('公款', val(res,'库存灵石'))}
            </div>
        </div>

        <div class="sec-title"><i class="fa-solid fa-gopuram"></i> 宗门建筑</div>
        <div class="card">
            <div class="data-grid g-2">${bHtml}</div>
        </div>`;
    },

    // Tab 3: 行囊 (Bag)
    bag: (d) => {
        const a = d['资产']||{};
        const b = list(d, '行囊.背包');

        const currencyList = ['极品灵石','上品灵石','中品灵石','下品灵石','黄金','白银','铜钱'];
        const moneyHtml = currencyList.map(k => {
            const v = val(a, k, 0); 
            let color = '#7f8c8d';
            let icon = '';
            if(k.includes('灵石')) { color = 'var(--cyan)'; icon='✦'; }
            if(k==='黄金') { color = 'var(--gold)'; icon='●'; }
            return `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #eee; font-size:0.8rem;">
                <span style="color:#999">${icon} ${k}</span> <span style="font-weight:bold; color:${color}; font-family:monospace; font-size:0.9rem">${v}</span>
            </div>`;
        }).join('');

        const itemHtml = b.length ? b.map(i => {
            const q = val(i,'品质','白');
            let qc = '#f0f0f0';
            let tc = '#666';
            if(q.includes('金')) { qc = '#fff8e1'; tc = '#d4af37'; }
            else if(q.includes('紫')) { qc = '#f3e5f5'; tc = '#9b59b6'; }
            else if(q.includes('蓝')) { qc = '#e3f2fd'; tc = '#3498db'; }
            else if(q.includes('绿')) { qc = '#e8f5e9'; tc = '#2ecc71'; }
            return `
            <div class="list-item">
                <div class="item-icon" style="background:${qc}; color:${tc}; border-color:${qc}"><i class="fa-solid fa-box"></i></div>
                <div class="item-main">
                    <div class="item-title">
                        <span>${val(i,'名称')}</span>
                        <span style="font-size:0.75rem; color:#999; font-weight:normal">x${val(i,'数量')}</span>
                    </div>
                    <div class="item-sub">${val(i,'描述')}</div>
                </div>
            </div>`;
        }).join('') : '<div style="text-align:center;padding:40px;color:#ccc">纳戒空空如也</div>';

        return `
        <div class="sec-title"><i class="fa-solid fa-coins"></i> 财帛</div>
        <div class="card">
            <div class="data-grid g-2" style="gap:15px">${moneyHtml}</div>
        </div>
        <div class="sec-title"><i class="fa-solid fa-box-open"></i> 纳戒物品</div>
        <div class="card" style="padding:0 16px">${itemHtml}</div>`;
    },

    // Tab 4: 寻缘 (Social)
    social: (d) => {
        const npcs = list(d, '寻缘蝶');
        if(!npcs.length) return '<div style="text-align:center;padding:100px 20px;color:#ccc;font-style:italic">暂无羁绊<br><span style="font-size:0.75rem">红尘炼心，莫问前程</span></div>';
        
        window._npcs = npcs; 

        return npcs.map((n, i) => `
        <div class="card" onclick="openModal(${i})" style="cursor:pointer; display:flex; gap:15px; align-items:center;">
            <div class="item-icon" style="width:48px;height:48px;font-size:1.2rem;background:#fcfcfc;font-family:var(--font-title);color:var(--ink)">${val(n,'姓名')[0]}</div>
            <div class="item-main">
                <div class="item-title" style="margin-bottom:4px">
                    <span>${val(n,'姓名')} <span style="font-weight:normal;color:#999;font-size:0.7rem; margin-left:4px">${val(n,'道号')||''}</span></span>
                    <span style="color:var(--vermilion); font-size:0.8rem"><i class="fa-solid fa-heart"></i> ${val(n,'好感度')}</span>
                </div>
                <div style="display:flex; gap:6px">
                    <span class="tag t-outline">${val(n,'境界')}</span>
                    <span class="tag t-outline">${val(n,'关系')}</span>
                </div>
            </div>
            <i class="fa-solid fa-chevron-right" style="color:#ddd; font-size:0.8rem"></i>
        </div>`).join('');
    },

    // Tab 5: 天机 (News)
    news: (d) => {
        const n = d['宅仙报']||{};
        const logs = val(d,'战斗.战斗日志')||[];
        const logArr = Array.isArray(logs)?logs:[logs];
        const pets = list(d, '灵兽栏'); 

        const petHtml = pets.length ? pets.map(p => `
        <div class="list-item">
            <div class="item-icon" style="background:#e0f2f1; color:#009688; border:none"><i class="fa-solid fa-paw"></i></div>
            <div class="item-main">
                <div class="item-title">
                    <span>${val(p,'名称')} <span style="font-size:0.7rem;color:#999;font-weight:normal">(${val(p,'种族')})</span></span>
                    <span class="tag t-gold">${val(p,'境界')}</span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px">
                    <span class="tag t-outline">${val(p,'化形状态')}</span>
                    <div style="flex:1; margin-left:15px">${bar('忠诚', val(p,'忠诚度'), 100, '#009688').replace('margin-bottom: 10px', 'margin-bottom: 0')}</div>
                </div>
            </div>
        </div>`).join('') : '<div style="text-align:center;color:#ccc;padding:10px">无灵兽</div>';

        return `
        ${logArr[0] !== '暂无战斗记录' ? `<div class="card" style="border-left:3px solid var(--vermilion); background:#fffaf9"><div style="font-weight:bold; color:var(--vermilion); font-size:0.85rem; margin-bottom:6px"><i class="fa-solid fa-bolt"></i> 战斗速报</div><div style="line-height:1.5; color:#444; font-size:0.85rem">${logArr.join('<br>')}</div></div>` : ''}

        <div class="sec-title"><i class="fa-solid fa-dragon"></i> 灵兽栏</div>
        <div class="card" style="padding:0 16px">${petHtml}</div>

        <div class="sec-title"><i class="fa-solid fa-scroll"></i> 宅仙报</div>
        <div class="card">
            <div style="margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed #eee">
                <div style="font-weight:bold; color:var(--cyan); font-size:0.8rem; margin-bottom:4px">天机阁榜单</div>
                <div style="color:#444; line-height:1.5; font-size:0.85rem">${val(n,'天机阁')}</div>
            </div>
            <div style="margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed #eee">
                <div style="font-weight:bold; color:var(--gold); font-size:0.8rem; margin-bottom:4px">散仙小道</div>
                <div style="color:#444; line-height:1.5; font-size:0.85rem">${val(n,'散仙小道')}</div>
            </div>
            <div>
                <div style="font-weight:bold; color:var(--vermilion); font-size:0.8rem; margin-bottom:4px">宅仙有话说</div>
                <div style="color:#666; font-style:italic; line-height:1.5; font-size:0.85rem; background:#f9f9f9; padding:8px; border-radius:6px">"${val(n,'宅仙有话说')}"</div>
            </div>
        </div>`;
    }
};

// ===============================================
// 3. 交互逻辑 (Interaction)
// ===============================================
let lastData = {};

window.Tab = (key) => {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const idx = ['status','sect','bag','social','news'].indexOf(key);
    if(idx >= 0) document.querySelectorAll('.nav-btn')[idx].classList.add('active');
    
    const view = document.getElementById('view');
    view.scrollTop = 0;
    view.innerHTML = UI[key] ? UI[key](lastData) : '<div style="padding:50px;text-align:center;color:#ccc">天道演算中...</div>';
};

window.openModal = (idx) => {
    const n = window._npcs[idx];
    if(!n) return;
    
    const sens = n['敏感度'] || (n['生理'] ? n['生理']['敏感度'] : {}) || {};
    const preg = n['孕育'] || (n['生理'] ? n['生理']['孕育'] : {}) || {};
    
    const npcSkill = list(n, '功法').map(i => `<span class="tag t-gold" style="margin:2px">${val(i,'名称')}</span>`).join('') || '<span class="tag t-outline">无</span>';
    const npcAbility = list(n, '神通').map(i => `<span class="tag t-cyan" style="margin:2px">${val(i,'名称')}</span>`).join('') || '<span class="tag t-outline">无</span>';

    let sensHtml = '';
    for(let k in sens) {
        if(k==='$meta') continue;
        let v = Array.isArray(sens[k])?sens[k][0]:sens[k];
        sensHtml += bar(k, v, 100, '#8e73ad');
    }

    const html = `
    <div style="display:flex; gap:16px; margin-bottom:20px; align-items:center;">
        <div class="seal" style="width:60px;height:60px;font-size:1.5rem">${val(n,'姓名')[0]}</div>
        <div style="flex:1">
            <div style="font-size:1.4rem; font-weight:bold; color:var(--ink); font-family:var(--font-title)">${val(n,'姓名')} <span style="font-size:0.8rem; color:#999; font-weight:normal; font-family:var(--font-body)">${val(n,'道号')||''}</span></div>
            <div style="display:flex; gap:6px; margin-top:6px">
                <span class="tag t-gold">${val(n,'境界')}</span>
                <span class="tag t-outline">${val(n,'当前状态','正常')}</span>
            </div>
            <div style="font-size:0.8rem; color:#999; margin-top:6px; font-style:italic">"${val(n,'心理活动','...')}"</div>
        </div>
    </div>

    <div class="card">
        ${bar('命', val(n,'当前命'), val(n,'命'), '#c0392b')}
        ${bar('灵', val(n,'当前灵'), val(n,'灵'), '#2980b9')}
        ${bar('道心', val(n,'道心'), 100, '#8e44ad')}
        <div style="margin-top:12px; border-top:1px dashed #eee; padding-top:10px">
            <div class="data-grid g-2">
                <div>
                    <div style="font-size:0.6rem; color:#999; margin-bottom:4px">功法</div>
                    <div style="line-height:1.4">${npcSkill}</div>
                </div>
                <div>
                    <div style="font-size:0.6rem; color:#999; margin-bottom:4px">神通</div>
                    <div style="line-height:1.4">${npcAbility}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="data-grid g-4">
            ${kv('种族', val(n,'种族'))}
            ${kv('年龄', val(n,'年龄'))}
            ${kv('气运', val(n,'气运'), 'var(--gold)')}
            ${kv('势力', val(n,'势力'))}
        </div>
        <div class="data-grid g-3" style="margin-top:10px">
            ${kv('灵根', val(n,'灵根'))}
            ${kv('体质', val(n,'体质'))}
            ${kv('灵器', val(n,'灵器'))}
            ${kv('所在地', val(n,'所在地'))}
            ${kv('三围', val(n,'三围'))}
            ${kv('标记', val(n,'标记'))}
        </div>
        <div class="data-grid g-3" style="margin-top:10px; border-top:1px dashed #eee; padding-top:10px">
            ${kv('性格', val(n,'性格'))}
            ${val(n,'性格2') && val(n,'性格2')!=='未知' ? kv('隐性', val(n,'性格2')) : ''}
            ${kv('弱点', val(n,'弱点'))}
            ${kv('喜好', val(n,'喜好'))}
            ${kv('嫉妒心', val(n,'嫉妒心'), 'var(--vermilion)')}
        </div>
    </div>

    <div class="card" style="border:1px solid #f3e5f5;">
        ${bar('好感', val(n,'好感度'), 100, '#c0392b')}
        ${bar('顺从', val(n,'顺从度'), 100, '#2980b9')}
        ${bar('堕落', val(n,'堕落值'), 100, '#2c3e50')}

        <div class="data-grid g-2" style="margin-top:12px; margin-bottom:12px">
            ${kv('元阴', val(n,'元阴'), String(val(n,'元阴')).includes('锁')?'var(--gold)':'var(--vermilion)')}
            ${kv('合欢次数', val(n,'合欢数'))}
        </div>
        
        <div style="background:#fdf2f7; padding:8px; border-radius:6px; text-align:center; border:1px solid #f8bbd0; margin-bottom:12px">
            <span style="font-size:0.75rem; color:#888">孕育状态: </span>
            <span style="font-weight:bold; color:var(--vermilion); font-size:0.9rem">${val(preg,'状态')} <span style="font-size:0.75rem">(${val(preg,'进度')}%)</span></span>
        </div>

        <div style="border-top:1px dashed #f0d0e0; padding-top:10px">
            <div style="font-size:0.7rem; color:#8e44ad; margin-bottom:6px; font-weight:bold">敏感度开发</div>
            ${sensHtml || '<div style="color:#ccc; font-size:0.7rem">未知</div>'}
        </div>
    </div>

    <div class="card">
        <div style="line-height:1.6; font-size:0.85rem">
            <div style="margin-bottom:8px"><strong style="color:var(--gold)">外貌：</strong> ${val(n,'外貌')}</div>
            <div><strong style="color:var(--gold)">衣着：</strong> ${val(n,'衣着')}</div>
        </div>
    </div>
    `;
    
    document.getElementById('m-title').innerText = val(n,'姓名');
    document.getElementById('m-content').innerHTML = html;
    document.getElementById('modal').classList.add('show');
};

window.closeModal = () => document.getElementById('modal').classList.remove('show');

// ===============================================
// 4. 初始化
// ===============================================
const init = async () => {
    try {
        let d = {};
        if (typeof getChatMessages === 'function') {
            const msgs = await getChatMessages(getCurrentMessageId());
            d = msgs?.[0]?.data?.stat_data || {};
        } else if (window.lastData) {
            d = window.lastData;
        }
        lastData = d;
        UI.header(d);
        Tab('status'); 
        
        if (typeof waitGlobalInitialized === 'function') {
            waitGlobalInitialized('Mvu').then(() => {
                if (typeof Mvu !== 'undefined') {
                    eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, m => {
                        if (m?.stat_data) {
                            lastData = m.stat_data;
                            UI.header(lastData);
                            const active = document.querySelector('.nav-btn.active');
                            const key = active ? active.getAttribute('onclick').match(/'(.*)'/)[1] : 'status';
                            Tab(key);
                        }
                    });
                }
            });
        }
    } catch (e) { console.error(e); }
};

if (typeof waitGlobalInitialized === 'function') waitGlobalInitialized('Mvu').then(init);
else setTimeout(init, 100);

})();
</script>
</body>
</html>