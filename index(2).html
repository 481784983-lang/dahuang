<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
<style>
    :root {
        --c-bg: #fcf9f2;
        --c-text: #2c2c2c;
        --c-sub: #666;
        --c-gold: #b8860b;
        --c-gold-light: #fdfbf0;
        --c-red: #c0392b;
        --c-blue: #2980b9;
        --c-purple: #8e44ad;
        --c-pink: #d980fa;
        --c-border: #e6dcb8;
        --font-title: 'Ma Shan Zheng', cursive;
        --font-body: 'Noto Serif SC', serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    
    body {
        margin: 0; padding: 0; width: 100%; height: 100vh;
        display: flex; justify-content: center; align-items: center;
        background: transparent; font-family: var(--font-body); color: var(--c-text);
    }

    /* 主容器 */
    .wrapper {
        position: relative; width: 100%; max-width: 500px;
        height: 80vh; min-height: 600px;
        background: var(--c-bg);
        border: 2px solid var(--c-gold); border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        display: flex; flex-direction: column; overflow: hidden;
    }
    
    .wrapper.combat { border-color: var(--c-red); box-shadow: 0 0 25px rgba(192, 57, 43, 0.5); }

    /* 四角云纹 */
    .corner { position: absolute; width: 15px; height: 15px; border: 2px solid var(--c-gold); z-index: 10; pointer-events: none; }
    .tl { top: 4px; left: 4px; border-right: 0; border-bottom: 0; }
    .tr { top: 4px; right: 4px; border-left: 0; border-bottom: 0; }
    .bl { bottom: 4px; left: 4px; border-right: 0; border-top: 0; }
    .br { bottom: 4px; right: 4px; border-left: 0; border-top: 0; }

    /* 顶部Header */
    .header {
        padding: 10px 15px; background: rgba(255,255,255,0.9);
        border-bottom: 1px solid var(--c-border); flex-shrink: 0;
        display: flex; justify-content: space-between; align-items: flex-start;
    }
    .h-left { display: flex; flex-direction: column; }
    .h-right { text-align: right; font-size: 0.75rem; color: var(--c-sub); }
    .tag-box { display: inline-flex; gap: 4px; margin-top: 4px; }
    .tag { padding: 0 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.65rem; background: #fff; }

    /* 内容滚动区 */
    .content { flex: 1; overflow-y: auto; padding: 12px; scrollbar-width: thin; scrollbar-color: var(--c-gold) transparent; }
    .content::-webkit-scrollbar { width: 4px; }
    .content::-webkit-scrollbar-thumb { background: var(--c-gold); border-radius: 2px; }

    /* 底部导航 */
    .navbar {
        height: 60px; background: #fff; border-top: 1px solid var(--c-border);
        display: flex; justify-content: space-around; align-items: center; flex-shrink: 0;
    }
    .nav-btn {
        display: flex; flex-direction: column; align-items: center; gap: 2px;
        font-size: 0.7rem; color: #aaa; cursor: pointer; width: 20%; transition: 0.2s;
    }
    .nav-btn i { font-size: 1.2rem; margin-bottom: 2px; }
    .nav-btn.active { color: var(--c-gold); transform: translateY(-2px); text-shadow: 0 2px 5px rgba(184,134,11,0.2); }

    /* 通用组件 */
    .card { background: #fff; border: 1px solid #eee; border-radius: 6px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); overflow: hidden; }
    .card-h { 
        padding: 6px 10px; background: var(--c-gold-light); border-bottom: 1px solid #f0f0f0;
        font-size: 0.85rem; font-weight: bold; color: var(--c-gold); display: flex; justify-content: space-between;
    }
    .card-b { padding: 10px; font-size: 0.85rem; }

    /* 键值对网格 - 优化排版 */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
    
    .kv { background: #fcfcfc; border: 1px solid #f2f2f2; padding: 4px; border-radius: 4px; text-align: center; display:flex; flex-direction:column; justify-content:center; min-height: 42px;}
    .k { font-size: 0.65rem; color: #999; margin-bottom: 2px; }
    /* 修复长文本遮挡问题 */
    .v { 
        font-size: 0.8rem; 
        font-weight: bold; 
        color: #333; 
        white-space: normal; /* 允许换行 */
        line-height: 1.1;    /* 紧凑行高 */
        word-break: break-all; /* 防止长英文撑开 */
        display: -webkit-box;
        -webkit-line-clamp: 2; /* 最多显示2行 */
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* 进度条 */
    .bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
    .bar-lbl { width: 30px; text-align: right; font-size: 0.7rem; color: #888; }
    .bar-track { flex: 1; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; }
    .bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
    .bar-val { width: 35px; text-align: right; font-size: 0.7rem; font-family: monospace; color: #555; }

    /* 列表项 */
    .item { display: flex; gap: 10px; padding: 8px 0; border-bottom: 1px dashed #eee; align-items: center; }
    .item:last-child { border-bottom: none; }
    .icon { width: 32px; height: 32px; background: #f4f4f4; color: #666; display: grid; place-items: center; border-radius: 4px; font-size: 0.9rem; flex-shrink: 0; border: 1px solid #eee; }

    /* 模态框 */
    .modal {
        position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 99;
        display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: 0.2s;
    }
    .modal.show { opacity: 1; pointer-events: auto; }
    .m-panel {
        width: 100%; height: 92%; background: var(--c-bg);
        border-radius: 12px 12px 0 0; border-top: 3px solid var(--c-gold);
        display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .modal.show .m-panel { transform: translateY(0); }
    .m-head { padding: 12px; background: #fff; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    .m-body { flex: 1; overflow-y: auto; padding: 12px; }

</style>
</head>
<body>

<div class="wrapper" id="app">
    <div class="corner tl"></div><div class="corner tr"></div>
    <div class="corner bl"></div><div class="corner br"></div>

    <div class="header">
        <div class="h-left">
            <div style="font-family:var(--font-title); font-size:1.5rem; color:var(--c-gold); line-height:1.1" id="ui-loc">未知之地</div>
            <div style="font-size:0.75rem; color:#888; margin-top:3px" id="ui-time">混沌未开</div>
        </div>
        <div class="h-right">
            <div id="ui-state" style="font-weight:bold; color:var(--c-text)">世界动态: 无</div>
            <div class="tag-box">
                <span class="tag" id="ui-qi">气: 稀薄</span>
                <span class="tag" id="ui-weather">候: 晴朗</span>
            </div>
            <div style="margin-top:2px; color:var(--c-red)">天道压制: <span id="ui-sup">0%</span></div>
        </div>
    </div>

    <div class="content" id="view"></div>

    <div class="navbar">
        <div class="nav-btn active" onclick="Tab('status')"><i class="fa-solid fa-user-astronaut"></i>道体</div>
        <div class="nav-btn" onclick="Tab('sect')"><i class="fa-solid fa-place-of-worship"></i>宗门</div>
        <div class="nav-btn" onclick="Tab('bag')"><i class="fa-solid fa-sack-dollar"></i>行囊</div>
        <div class="nav-btn" onclick="Tab('social')"><i class="fa-solid fa-fan"></i>寻缘</div>
        <div class="nav-btn" onclick="Tab('news')"><i class="fa-solid fa-scroll"></i>天机</div>
    </div>

    <div class="modal" id="modal">
        <div class="m-panel">
            <div class="m-head">
                <div style="font-weight:bold; font-size:1.2rem; font-family:var(--font-title); color:var(--c-gold)" id="m-title">详情</div>
                <div onclick="closeModal()" style="font-size:1.5rem; padding:0 10px; cursor:pointer; color:#999">&times;</div>
            </div>
            <div class="m-body" id="m-content"></div>
        </div>
    </div>
</div>

<script>
(function() {

// ===============================================
// 1. 数据解析 (Robust Parser V2 - Object Compatible)
// ===============================================

// 安全取值
const get = (root, path) => {
    try {
        if(!root) return undefined;
        return path.split('.').reduce((obj, k) => {
            const m = k.match(/^(.+)\[(\d+)\]$/);
            if(m && obj[m[1]]) return obj[m[1]][parseInt(m[2])];
            return (obj && obj[k] !== undefined) ? obj[k] : undefined;
        }, root);
    } catch(e) { return undefined; }
};

// 智能解包：处理 [Val, Desc] 或 Val
const val = (root, path, def = '无') => {
    const v = get(root, path);
    if(v === undefined || v === null) return def;
    // 如果是数组且第一项是字面量 -> 取值
    if(Array.isArray(v) && v.length > 0 && typeof v[0] !== 'object') {
        return (v[0] === '' || v[0] === 0) ? (v[0] === 0 ? 0 : def) : v[0];
    }
    // 如果是对象但非数组 -> 不显示
    if(typeof v === 'object' && !Array.isArray(v)) return def;
    // 基础类型
    return (v === '' || v === 0) ? (v===0?0:def) : v;
};

// 列表过滤器
const list = (root, path) => {
    const v = get(root, path);
    if(!v) return [];
    
    // 情况A: 数组 (Old compatibility)
    if(Array.isArray(v)) {
        return v.filter(i => i && typeof i === 'object' && !i.$meta && (get(i, '名称') || get(i, '姓名')));
    }
    
    // 情况B: 对象 (New Standard for assign)
    if(typeof v === 'object') {
        return Object.keys(v)
            .filter(k => k !== '$meta') // 过滤元数据
            .map(k => {
                const item = v[k];
                if(typeof item !== 'object') return null;
                return { ...item, _key: k };
            })
            .filter(i => i !== null && (get(i, '名称') || get(i, '姓名'))); // 确保有效
    }
    
    return [];
};

// 组件：进度条
const bar = (label, cur, max, color) => {
    const c = parseFloat(cur)||0; const m = parseFloat(max)||100;
    const pct = Math.min(100, m>0?(c/m)*100:0);
    return `<div class="bar-row">
        <div class="bar-lbl">${label}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${pct}%; background:${color}"></div></div>
        <div class="bar-val">${Math.floor(c)}</div>
    </div>`;
};

// 组件：KV块
const kv = (k, v, color='') => `<div class="kv"><div class="k">${k}</div><div class="v" style="color:${color}">${v}</div></div>`;

// ===============================================
// 2. 渲染逻辑 (Renderers)
// ===============================================
const UI = {
    // 头部
    header: (d) => {
        const w = d['世界']||{};
        const c = d['战斗']||{};
        document.getElementById('ui-loc').innerText = val(w,'地点','大荒');
        document.getElementById('ui-time').innerText = val(w,'时间','太古历');
        document.getElementById('ui-state').innerText = val(w,'世界动态','平静');
        document.getElementById('ui-qi').innerText = '气: ' + val(w,'灵气浓度','稀薄');
        document.getElementById('ui-weather').innerText = '候: ' + val(w,'天气','晴');
        document.getElementById('ui-sup').innerText = val(w,'天道压制', 0) + '%';
        
        const state = val(c,'状态');
        document.getElementById('app').classList.toggle('combat', state !== '空闲' && state !== '无');
    },

    // Tab 1: 道体 (Status)
    status: (d) => {
        const p = d['主角']||{};
        const phy = p['生理']||{};
        const sk = p['技艺']||{};
        
        const kf = list(p,'功法').map(i=>`<span style="background:#fff8e1;color:#b8860b;padding:2px 5px;border-radius:3px;font-size:0.7rem;margin:0 4px 4px 0;display:inline-block;border:1px solid #f0e6c0">${val(i,'名称')}</span>`).join('') || '暂无功法';
        const ab = list(p,'神通').map(i=>`<span style="background:#eaf2f8;color:#2980b9;padding:2px 5px;border-radius:3px;font-size:0.7rem;margin:0 4px 4px 0;display:inline-block;border:1px solid #d6eaf8">${val(i,'名称')}</span>`).join('') || '暂无神通';

        return `
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:15px;">
            <div style="width:64px; height:64px; background:#333; color:#b8860b; border-radius:50%; display:flex; justify-content:center; align-items:center; text-align:center; font-family:var(--font-title); font-size:0.9rem; border:2px solid #fff; box-shadow:0 4px 8px rgba(0,0,0,0.2); padding:2px; line-height:1.2; word-break:break-all;">${val(p,'境界','凡')}</div>
            <div>
                <div style="font-size:1.3rem; font-weight:bold;">${val(p,'姓名','无名氏')}</div>
                <div style="font-size:0.75rem; color:#666;">${val(p,'种族')} · ${val(p,'体质')} · <span style="color:var(--c-gold)">${val(p,'气运')}</span></div>
            </div>
        </div>

        <div class="card">
            <div class="card-h"><span>根基状态</span><span style="font-size:0.7rem; color:#999">Vitals</span></div>
            <div class="card-b">
                ${bar('命', val(p,'当前命'), val(p,'命'), '#e74c3c')}
                ${bar('灵', val(p,'当前灵'), val(p,'灵'), '#3498db')}
                ${bar('道心', val(p,'道心'), 100, '#9b59b6')}
                ${bar('悟性', val(p,'悟'), 100, '#f39c12')}
                ${bar('欲望', val(phy,'欲望槽'), 100, '#d980fa')}
            </div>
        </div>

        <div class="card">
            <div class="card-h"><span>综合属性</span></div>
            <div class="card-b">
                <div class="grid-4">
                    ${kv('年龄', val(p,'年龄'))}
                    ${kv('战力', val(p,'战力'))}
                    ${kv('神识', val(p,'神识'))}
                    ${kv('魅力', val(p,'魅力'), 'var(--c-pink)')}
                </div>
                <div class="grid-3" style="margin-top:6px">
                    ${kv('灵根', val(p,'灵根'))}
                    ${kv('阵营', val(p,'阵营'))}
                    ${kv('名声', val(p,'名声'))}
                    ${kv('体香', val(phy,'体香'), 'var(--c-pink)')}
                    ${kv('丹道', val(sk,'炼丹'))}
                    ${kv('器道', val(sk,'炼器'))}
                </div>
            </div>
        </div>

        <div class="card"><div class="card-h">所学</div><div class="card-b">
            <div style="margin-bottom:8px"><div style="color:#888;font-size:0.75rem;margin-bottom:4px">功法</div>${kf}</div>
            <div style="border-top:1px dashed #eee; padding-top:8px"><div style="color:#888;font-size:0.75rem;margin-bottom:4px">神通</div>${ab}</div>
        </div></div>`;
    },

    // Tab 2: 宗门 (Sect) - 增强版 (自动兼容嵌套与扁平结构)
    sect: (d) => {
        let s = get(d, '宗门.my_sect'); // 1. 优先尝试标准路径
        
        // 2. 容错处理：如果 my_sect 不存在，尝试将 '宗门' 视为直辖对象 (扁平结构兼容)
        if (!s || !val(s, '名称') || val(s, '名称') === '无') {
            const rootSect = get(d, '宗门');
            // 如果 宗门 根节点本身就有 '名称' 字段，说明是扁平结构
            if (rootSect && get(rootSect, '名称')) {
                s = rootSect;
            } 
            // 3. 终极容错：如果还是不行，抓取 '宗门' 下的第一个有效对象 (如 kunlun_dao_gong)
            else if (rootSect) {
                const firstKey = Object.keys(rootSect).find(k => 
                    k !== '$meta' && 
                    typeof rootSect[k] === 'object' && 
                    val(rootSect[k], '名称') !== '无'
                );
                if (firstKey) s = rootSect[firstKey];
            }
        }

        // 依然没有找到有效数据，显示空状态
        if(!s || !val(s,'名称') || val(s,'名称')==='无' || val(s,'名称')==='未知宗门') 
            return '<div style="text-align:center;padding:50px;color:#ccc">暂无宗门归属</div>';
        
        const res = s['资源']||{};
        const blds = s['建筑']||{};
        
        // 建筑列表渲染
        let bHtml = '';
        const bldKeys = Object.keys(blds);
        if (bldKeys.length === 0) bHtml = '<div style="color:#ccc;font-size:0.8rem">暂无建筑</div>';
        else {
            for(let k of bldKeys) {
                if(k==='$meta') continue;
                // 兼容逻辑：处理 [等级, 描述] 数组格式 或 直接数字格式
                let raw = blds[k];
                let lv = Array.isArray(raw) ? raw[0] : raw;
                bHtml += kv(k, 'Lv.' + lv);
            }
        }

        return `
        <div class="card" style="border-top:3px solid var(--c-gold)">
            <div class="card-b" style="text-align:center;">
                <div style="font-family:var(--font-title); font-size:1.4rem; color:var(--c-gold)">${val(s,'名称')}</div>
                <div style="margin-top:5px;display:inline-block;padding:2px 10px;border:1px solid #e0d0a0;border-radius:12px;background:#fffdf0;font-size:0.8rem">${val(s,'等级')}品势力</div>
            </div>
            <div class="card-b">
                <div class="grid-3">
                    ${kv('声望', val(s,'声望'))}
                    ${kv('灵脉', val(res,'灵脉'))}
                    ${kv('公款', val(res,'库存灵石'))}
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-h">宗门建筑</div>
            <div class="card-b">
                <div class="grid-2">${bHtml}</div>
            </div>
        </div>`;
    },

    // Tab 3: 行囊 (Bag)
    bag: (d) => {
        const a = d['资产']||{};
        const b = list(d, '行囊.背包');

        const currencyList = ['极品灵石','上品灵石','中品灵石','下品灵石','黄金','白银','铜钱'];
        const moneyHtml = currencyList.map(k => {
            const v = val(a, k, 0); 
            let color = '#555';
            if(k.includes('灵石')) color = 'var(--c-blue)';
            if(k==='黄金') color = 'var(--c-gold)';
            return `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px dashed #f0f0f0; font-size:0.8rem;">
                <span style="color:#999">${k}</span> <span style="font-weight:bold; color:${color}">${v}</span>
            </div>`;
        }).join('');

        const itemHtml = b.length ? b.map(i => {
            const q = val(i,'品质','白');
            let qc = '#ddd';
            if(q.includes('金')) qc = 'var(--c-gold)';
            else if(q.includes('紫')) qc = 'var(--c-purple)';
            else if(q.includes('蓝')) qc = 'var(--c-blue)';
            else if(q.includes('绿')) qc = '#2ecc71';
            return `
            <div class="item">
                <div class="icon" style="border-color:${qc}; color:${qc}"><i class="fa-solid fa-box"></i></div>
                <div style="flex:1">
                    <div style="display:flex; justify-content:space-between">
                        <span style="font-weight:bold">${val(i,'名称')}</span>
                        <span style="font-size:0.75rem; color:#888">x${val(i,'数量')}</span>
                    </div>
                    <div style="font-size:0.7rem; color:#999; margin-top:2px">${val(i,'描述')}</div>
                </div>
            </div>`;
        }).join('') : '<div style="text-align:center;padding:20px;color:#ccc">空</div>';

        return `
        <div class="card"><div class="card-h">财帛</div><div class="card-b" style="display:grid; grid-template-columns:1fr 1fr; gap:15px">${moneyHtml}</div></div>
        <div class="card"><div class="card-h">纳戒物品</div><div class="card-b">${itemHtml}</div></div>`;
    },

    // Tab 4: 寻缘 (Social)
    social: (d) => {
        const npcs = list(d, '寻缘蝶');
        if(!npcs.length) return '<div style="text-align:center;padding:50px;color:#ccc">孤身一人</div>';
        
        window._npcs = npcs; 

        return npcs.map((n, i) => `
        <div class="card" onclick="openModal(${i})" style="cursor:pointer">
            <div class="card-b" style="display:flex; gap:10px; align-items:center">
                <div style="width:42px; height:42px; border-radius:50%; background:#fcfcfc; border:1px solid #ddd; color:#555; display:grid; place-items:center; font-family:var(--font-title); font-size:1.3rem">${val(n,'姓名')[0]}</div>
                <div style="flex:1">
                    <div style="display:flex; justify-content:space-between">
                        <span style="font-weight:bold">${val(n,'姓名')} <span style="font-weight:normal;color:#999;font-size:0.7rem">${val(n,'道号')||''}</span></span>
                        <span style="color:var(--c-pink); font-size:0.8rem"><i class="fa-solid fa-heart"></i> ${val(n,'好感度')}</span>
                    </div>
                    <div style="font-size:0.75rem; color:#666; margin-top:2px">${val(n,'境界')} · ${val(n,'关系')}</div>
                </div>
                <i class="fa-solid fa-chevron-right" style="color:#ddd"></i>
            </div>
        </div>`).join('');
    },

    // Tab 5: 天机 (News)
    news: (d) => {
        const n = d['宅仙报']||{};
        const logs = val(d,'战斗.战斗日志')||[];
        const logArr = Array.isArray(logs)?logs:[logs];
        const pets = list(d, '灵兽栏'); 

        const petHtml = pets.length ? pets.map(p => `
        <div class="item">
            <div class="icon" style="background:#2ecc71; color:#fff; border:none"><i class="fa-solid fa-paw"></i></div>
            <div style="flex:1">
                <div style="display:flex; justify-content:space-between">
                    <span>${val(p,'名称')}</span>
                    <span class="tag" style="color:var(--c-gold)">${val(p,'境界')}</span>
                </div>
                ${bar('忠诚', val(p,'忠诚度'), 100, '#e74c3c')}
            </div>
        </div>`).join('') : '<div style="text-align:center;color:#ccc">无灵兽</div>';

        return `
        ${logArr[0] !== '暂无战斗记录' ? `<div class="card" style="border-left:4px solid var(--c-red)"><div class="card-h" style="color:var(--c-red)">战斗速报</div><div class="card-b" style="line-height:1.4">${logArr.join('<br>')}</div></div>` : ''}

        <div class="card"><div class="card-h">灵兽栏</div><div class="card-b">${petHtml}</div></div>

        <div class="card">
            <div class="card-h">宅仙报</div>
            <div class="card-b">
                <div style="margin-bottom:8px"><strong>天机阁:</strong> ${val(n,'天机阁')}</div>
                <div style="margin-bottom:8px"><strong>散仙小道:</strong> ${val(n,'散仙小道')}</div>
                <div style="color:#666"><strong>宅仙有话说:</strong> ${val(n,'宅仙有话说')}</div>
            </div>
        </div>`;
    }
};

// ===============================================
// 3. 交互 (Interactions)
// ===============================================
let lastData = {};

window.Tab = (key) => {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const idx = ['status','sect','bag','social','news'].indexOf(key);
    if(idx >= 0) document.querySelectorAll('.nav-btn')[idx].classList.add('active');
    
    const view = document.getElementById('view');
    view.scrollTop = 0;
    view.innerHTML = UI[key] ? UI[key](lastData) : 'Loading...';
};

window.openModal = (idx) => {
    const n = window._npcs[idx];
    if(!n) return;
    
    const sens = n['敏感度'] || (n['生理'] ? n['生理']['敏感度'] : {}) || {};
    const preg = n['孕育'] || (n['生理'] ? n['生理']['孕育'] : {}) || {};
    
    let sensHtml = '';
    for(let k in sens) {
        if(k==='$meta') continue;
        let v = Array.isArray(sens[k])?sens[k][0]:sens[k];
        sensHtml += bar(k, v, 100, '#d980fa');
    }

    const html = `
    <div style="display:flex; gap:15px; margin-bottom:15px; align-items:center;">
        <div style="width:64px; height:64px; border-radius:50%; background:#fdfdfd; border:2px solid #b8860b; color:#b8860b; font-family:var(--font-title); font-size:1.8rem; display:grid; place-items:center;">${val(n,'姓名')[0]}</div>
        <div>
            <div style="font-size:1.3rem; font-weight:bold;">${val(n,'姓名')} <span style="font-size:0.7rem; border:1px solid #ccc; padding:0 5px; border-radius:4px; color:#666">${val(n,'境界')}</span></div>
            <div style="font-size:0.8rem; color:#888; margin-top:4px; font-style:italic">"${val(n,'心理活动','...')}"</div>
        </div>
    </div>

    <div class="card">
        <div class="card-h">基础档案</div>
        <div class="card-b">
            <div class="grid-4">
                ${kv('种族', val(n,'种族'))}
                ${kv('年龄', val(n,'年龄'))}
                ${kv('气运', val(n,'气运'), 'var(--c-gold)')}
                ${kv('势力', val(n,'势力'))}
            </div>
            <div class="grid-3" style="margin-top:6px">
                ${kv('灵根', val(n,'灵根'))}
                ${kv('体质', val(n,'体质'))}
                ${kv('灵器', val(n,'灵器'))}
                ${kv('所在地', val(n,'所在地'))}
                ${kv('三围', val(n,'三围'))}
                ${kv('标记', val(n,'标记'))}
            </div>
            <div class="grid-3" style="margin-top:5px; border-top:1px dashed #f0f0f0; padding-top:5px">
                ${kv('性格', val(n,'性格'))}
                ${kv('弱点', val(n,'弱点'))}
                ${kv('喜好', val(n,'喜好'))}
                ${kv('嫉妒心', val(n,'嫉妒心'), 'var(--c-red)')}
            </div>
        </div>
    </div>

    <div class="card" style="border-color:var(--c-pink)">
        <div class="card-h" style="background:#fff0f5; color:var(--c-pink)">极乐档案</div>
        <div class="card-b">
            ${bar('好感', val(n,'好感度'), 100, '#e74c3c')}
            ${bar('顺从', val(n,'顺从度'), 100, '#2980b9')}
            ${bar('堕落', val(n,'堕落值'), 100, '#2c3e50')}

            <div class="grid-2" style="margin-top:10px; margin-bottom:10px">
                ${kv('元阴', val(n,'元阴'), String(val(n,'元阴')).includes('锁')?'var(--c-gold)':'var(--c-red)')}
                ${kv('合欢次数', val(n,'合欢数'))}
            </div>
            
            <div style="background:#fff9fc; padding:5px; border-radius:4px; text-align:center; border:1px solid #fceef5; margin-bottom:10px">
                <span style="font-size:0.75rem; color:#888">孕育状态: </span>
                <span style="font-weight:bold; color:var(--c-pink)">${val(preg,'状态')} (${val(preg,'进度')}%)</span>
            </div>

            <div style="border-top:1px dashed #f0d0e0; padding-top:8px">
                <div style="font-size:0.75rem; color:#d980fa; margin-bottom:5px">敏感度开发</div>
                ${sensHtml || '<div style="color:#ccc; font-size:0.7rem">未知</div>'}
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-b" style="line-height:1.5">
            <div style="margin-bottom:5px"><strong style="color:var(--c-gold)">外貌：</strong> ${val(n,'外貌')}</div>
            <div><strong style="color:var(--c-gold)">衣着：</strong> ${val(n,'衣着')}</div>
        </div>
    </div>
    `;
    
    document.getElementById('m-title').innerText = val(n,'姓名');
    document.getElementById('m-content').innerHTML = html;
    document.getElementById('modal').classList.add('show');
};

window.closeModal = () => document.getElementById('modal').classList.remove('show');

// ===============================================
// 4. 初始化 (Initialization)
// ===============================================
const init = async () => {
    try {
        let d = {};
        if (typeof getChatMessages === 'function') {
            const msgs = await getChatMessages(getCurrentMessageId());
            d = msgs?.[0]?.data?.stat_data || {};
        } else if (window.lastData) {
            d = window.lastData;
        }
        lastData = d;
        UI.header(d);
        Tab('status'); 
        
        if (typeof waitGlobalInitialized === 'function') {
            waitGlobalInitialized('Mvu').then(() => {
                if (typeof Mvu !== 'undefined') {
                    eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, m => {
                        if (m?.stat_data) {
                            lastData = m.stat_data;
                            UI.header(lastData);
                            const active = document.querySelector('.nav-btn.active');
                            const key = active ? active.getAttribute('onclick').match(/'(.*)'/)[1] : 'status';
                            Tab(key);
                        }
                    });
                }
            });
        }
    } catch (e) { console.error(e); }
};

if (typeof waitGlobalInitialized === 'function') waitGlobalInitialized('Mvu').then(init);
else setTimeout(init, 100);

})();
</script>
</body>
</html>